<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molly ‚Äî Your License Key</title>
    <meta name="description" content="Your Molly license key is ready. Copy it and paste into the app to get started.">
    <link rel="icon" href="./icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b5;
            --text-muted: #6b6b80;
            --accent: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.3);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --gradient-main: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
        }

        /* Ambient background */
        .ambient-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .ambient-bg .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: #6366f1;
            top: -10%;
            left: -10%;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: #8b5cf6;
            bottom: -5%;
            right: -5%;
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 560px;
            width: 100%;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            padding: 48px 40px;
            text-align: center;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5), 0 0 120px var(--accent-glow);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .card h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .card-sub {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Status messages */
        .status-msg {
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-bottom: 24px;
            display: none;
        }

        .status-msg.loading {
            display: block;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-msg.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .status-msg.pending {
            display: block;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        /* License key display */
        .key-section {
            display: none;
        }

        .key-section.visible {
            display: block;
        }

        .key-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .key-box {
            position: relative;
            background: var(--bg-primary);
            border: 2px solid var(--accent);
            border-radius: 14px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .key-value {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--accent);
            word-break: break-all;
            user-select: all;
        }

        .key-plan {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 6px;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            border-radius: 12px;
            border: none;
            background: var(--gradient-main);
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 32px;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        /* Steps */
        .steps {
            text-align: left;
            margin-bottom: 32px;
        }

        .steps h3 {
            font-size: 0.95rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .step {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .step-num {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-text {
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.5;
            padding-top: 3px;
        }

        .step-text code {
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.82rem;
            color: var(--accent);
        }

        /* Download button */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
            padding: 16px 32px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            margin-bottom: 12px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
        }

        .download-note {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* Divider */
        .divider {
            border: none;
            border-top: 1px solid var(--border-subtle);
            margin: 32px 0;
        }

        /* Email lookup */
        .lookup-section {
            text-align: center;
        }

        .lookup-section h3 {
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .lookup-section p {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .lookup-form {
            display: flex;
            gap: 10px;
        }

        .lookup-form input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .lookup-form input:focus {
            border-color: var(--accent);
        }

        .lookup-form button {
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .lookup-form button:hover {
            border-color: var(--accent);
        }

        .lookup-results {
            margin-top: 16px;
            text-align: left;
        }

        .lookup-result-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .lookup-result-key {
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .lookup-result-meta {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .lookup-error {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 12px;
        }

        /* Footer */
        .footer-link {
            display: block;
            margin-top: 24px;
            color: var(--text-muted);
            font-size: 0.82rem;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 500px) {
            .card {
                padding: 32px 24px;
            }

            .key-value {
                font-size: 1.1rem;
            }

            .lookup-form {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-icon" id="cardIcon">üîë</div>
            <h1 id="cardTitle">Your License Key</h1>
            <p class="card-sub" id="cardSub">Thank you for your purchase! Here's your Molly license key.</p>

            <!-- Status messages -->
            <div class="status-msg" id="statusMsg"></div>

            <!-- Key display -->
            <div class="key-section" id="keySection">
                <div class="key-label">Your License Key</div>
                <div class="key-box">
                    <div class="key-value" id="keyValue"></div>
                    <div class="key-plan" id="keyPlan"></div>
                </div>
                <button class="copy-btn" id="copyBtn" onclick="copyKey()">
                    üìã Copy Key
                </button>

                <div class="steps">
                    <h3>How to activate:</h3>
                    <div class="step">
                        <div class="step-num">1</div>
                        <div class="step-text">Download Molly using the button below</div>
                    </div>
                    <div class="step">
                        <div class="step-num">2</div>
                        <div class="step-text">Extract the zip and run <code>start.bat</code></div>
                    </div>
                    <div class="step">
                        <div class="step-num">3</div>
                        <div class="step-text">Paste your key in the license input and click <strong>Activate</strong>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-num">4</div>
                        <div class="step-text">Molly will restart and you're in! üéâ</div>
                    </div>
                </div>

                <a href="/downloads/molly-latest.zip" class="download-btn" id="downloadBtn">
                    ‚¨áÔ∏è Download Molly
                </a>
                <div class="download-note">Windows only ‚Ä¢ ~50MB ‚Ä¢ Requires Node.js</div>
            </div>

            <hr class="divider">

            <!-- Email lookup -->
            <div class="lookup-section">
                <h3>Lost your key?</h3>
                <p>Enter the email you used during purchase to recover it.</p>
                <form class="lookup-form" id="lookupForm" onsubmit="lookupByEmail(event)">
                    <input type="email" id="lookupEmail" placeholder="your@email.com" required autocomplete="email">
                    <button type="submit" id="lookupBtn">Find Key</button>
                </form>
                <div id="lookupResults"></div>
            </div>
        </div>

        <a href="/" class="footer-link">‚Üê Back to Molly homepage</a>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : 'https://api.molly-body-swap.live';

        const statusMsg = document.getElementById('statusMsg');
        const keySection = document.getElementById('keySection');
        const keyValue = document.getElementById('keyValue');
        const keyPlan = document.getElementById('keyPlan');
        const cardIcon = document.getElementById('cardIcon');
        const cardTitle = document.getElementById('cardTitle');
        const cardSub = document.getElementById('cardSub');

        // Check for txid in URL params
        const params = new URLSearchParams(window.location.search);
        const txid = params.get('txid');

        if (txid) {
            fetchKeyByTxid(txid);
        } else {
            // No txid ‚Äî show email lookup mode
            cardIcon.textContent = 'üîç';
            cardTitle.textContent = 'Find Your License Key';
            cardSub.textContent = 'Enter the email you used during purchase to retrieve your key.';
        }

        async function fetchKeyByTxid(txid) {
            showStatus('loading', '‚è≥ Retrieving your license key...');

            try {
                const res = await fetch(`${API_BASE_URL}/api/lookup-key?txid=${encodeURIComponent(txid)}`);
                const data = await res.json();

                if (data.success) {
                    hideStatus();
                    showKey(data.license_key, data.plan);
                    cardIcon.textContent = '‚úÖ';
                    cardTitle.textContent = 'Payment Successful!';
                    cardSub.textContent = `Your ${data.plan} license is ready. Copy the key below and paste it into Molly.`;
                } else if (data.status === 'PENDING') {
                    showStatus('pending', '‚è≥ Payment is still processing. This page will auto-refresh in 10 seconds...');
                    cardIcon.textContent = '‚è≥';
                    cardTitle.textContent = 'Processing Payment...';
                    cardSub.textContent = 'Your payment is being confirmed. This usually takes 1-3 minutes.';
                    // Auto-retry
                    setTimeout(() => fetchKeyByTxid(txid), 10000);
                } else {
                    showStatus('error', data.error || 'Unable to retrieve your key.');
                    cardIcon.textContent = '‚ö†Ô∏è';
                    cardTitle.textContent = 'Key Not Found';
                    cardSub.textContent = 'Try looking up your key by email below.';
                }
            } catch (err) {
                showStatus('error', 'Network error. Please refresh the page or try the email lookup below.');
                cardIcon.textContent = '‚ö†Ô∏è';
                cardTitle.textContent = 'Connection Error';
                cardSub.textContent = 'Could not reach the server. Please try again.';
            }
        }

        function showKey(key, plan) {
            keyValue.textContent = key;
            if (plan) keyPlan.textContent = `Plan: ${plan}`;
            keySection.classList.add('visible');
        }

        function copyKey() {
            const key = keyValue.textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = 'üìã Copy Key';
                }, 2000);
            });
        }

        function showStatus(type, message) {
            statusMsg.className = `status-msg ${type}`;
            statusMsg.textContent = message;
        }

        function hideStatus() {
            statusMsg.style.display = 'none';
        }

        async function lookupByEmail(e) {
            e.preventDefault();
            const email = document.getElementById('lookupEmail').value.trim();
            const resultsDiv = document.getElementById('lookupResults');
            const btn = document.getElementById('lookupBtn');

            if (!email) return;

            btn.textContent = 'Searching...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/api/lookup-by-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (data.success && data.licenses.length > 0) {
                    resultsDiv.innerHTML = data.licenses.map(lic => `
                        <div class="lookup-result-item">
                            <div class="lookup-result-key">${lic.license_key}</div>
                            <div class="lookup-result-meta">${lic.plan} ‚Ä¢ Purchased ${lic.purchased}</div>
                        </div>
                    `).join('');

                    // Also show the first key in the main display
                    if (!keySection.classList.contains('visible')) {
                        showKey(data.licenses[0].license_key, data.licenses[0].plan);
                        cardIcon.textContent = '‚úÖ';
                        cardTitle.textContent = 'Key Found!';
                        cardSub.textContent = 'Here\'s your license key. Copy it and paste into Molly.';
                    }
                } else {
                    resultsDiv.innerHTML = `<p class="lookup-error">${data.error || 'No keys found for this email.'}</p>`;
                }
            } catch (err) {
                resultsDiv.innerHTML = '<p class="lookup-error">Network error. Please try again.</p>';
            }

            btn.textContent = 'Find Key';
            btn.disabled = false;
        }
    </script>
</body>

</html>